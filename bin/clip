#!/bin/bash

set -eu

source "${BASH_SOURCE%/*}"/run-user.sh

clip() {
  xclip -selection clipboard "$@"
}
clipout() {
  clip -o | base64
}
restore() {
  local now=$(clipout)
  [[ $now == "$content" ]] || return 0
  echo "$memory" | base64 -d | clip
}
clean() {
  restore
  clear-lock
}

if [[ ${1-} == -x ]]; then
  shift
  clip "$@"
  exit
fi
set-lock clip
pid=$LOCK_DIR/pid
until get-lock; do
  [[ -f $pid ]] && kill $(cat "$pid")
  sleep 0.1
done
memory=$(clipout)
clip "$@"
content=$(clipout)
(
  trap clean EXIT
  sleep 30 & wait
) & echo $! >"$pid"
