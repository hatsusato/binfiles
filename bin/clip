#!/bin/bash

set -eu

clip() {
  xclip -selection clipboard "$@"
}
clipout() {
  clip -o | base64
}
restore() {
  local now=$(clipout)
  [[ $now == "$content" ]] || return 0
  echo "$memory" | base64 -d | clip
}
clean() {
  restore
  rm -f "$lock"/pid
  rmdir "$lock"
}

if [[ ${1-} == -x ]]; then
  shift
  clip "$@"
  exit
fi
lock=${XDG_RUNTIME_DIR-/run/user/$UID}/clip.lock
pid=$lock/pid
until mkdir -m 700 "$lock" 2>/dev/null; do
  [[ -f $pid ]] && kill $(cat "$pid")
  sleep 0.1
done
memory=$(clipout)
clip "$@"
content=$(clipout)
(
  trap clean EXIT
  sleep 30 & wait
) & echo $! >"$pid"
