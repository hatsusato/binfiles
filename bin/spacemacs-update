#!/bin/bash

set -eu

source "${BASH_SOURCE%/*}"/spacemacs.sh

elisp() {
  local script
  case $1 in
    kill) script='(progn (defun yes-or-no-p (p) t) (kill-emacs))';;
    sync) script='(dotspacemacs/sync-configuration-layers)';;
    update) script='(configuration-layer/update-packages t)';;
    *) script=;;
  esac
  emacsclient -e "$script" >/dev/null || :
}
git-pull() {
  cd "$HOME"/.emacs.d
  git fetch --prune
  git merge --ff-only "$1"
}

exec 2> >(grep -v '^$' >&2) >&2
resolve-hup
spacemacs-exists && elisp kill
(git-pull "${1-origin/develop}")
emacs --fg-daemon &
until spacemacs-exists; do
  sleep 0.1
done
elisp update
elisp sync
elisp kill
spacemacs-daemon
