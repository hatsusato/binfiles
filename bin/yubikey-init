#!/bin/bash

set -eu

yubikey-status() {
  gpg --card-status --with-colons
}
yubikey-list() {
  gpg --list-secret-keys --with-colons
}
yubikey-fetch() {
  cat <<EOF | gpg --batch --command-fd 0 --card-edit 2> >(grep ^gpg: >&2)
fetch
quit
EOF
}
prompt-insert() {
  read -n1 -p 'Insert YubiKey and Hit Any Key.' -s
  echo >&2
}
parse-aid() {
  awk -F: 'match($1, /^Reader$/) {print $4}'
}
read-keyid() {
  local aid=$(yubikey-status | parse-aid)
  [[ -n $aid ]] || return 1
  local line ifs=$IFS
  while read line; do
    IFS=:
    set -- $line
    IFS=$ifs
    case $1 in
      sec) KEYID=$5;;
      ssb) [[ ${15} == $aid && -n $KEYID ]] && return;;
    esac
  done < <(yubikey-list)
  return 2
}
main() {
  while true; do
    KEYID=
    local -i err=0
    read-keyid || err=$?
    case $err in
      1) prompt-insert;;
      2) yubikey-fetch;;
      *) return $err;;
    esac
  done
}

export GNUPGHOME=$(init-run-user bin/yubikey/.gnupg)
[[ -d $GNUPGHOME ]] || exit
declare -g KEYID
main || exit
echo "$KEYID"
