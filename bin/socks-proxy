#!/bin/bash

set -eu

parse-config() {
  local line flag= b='[[:blank:]]'
  while read line; do
    if [[ $line == Host$b* ]]; then
      [[ $line == Host*$b"$1"?($b*) ]] && flag=on || flag=
    fi
    [[ -n $flag ]] || continue
    [[ $line == DynamicForward+($b)+([0-9]) ]] || continue
    echo ${line##*$b}
    return
  done
}
dynamic-port() {
  local line
  while read line; do
    line=$(cat "$line" | parse-config "$1")
    [[ -n $line ]] || continue
    echo "$line"
    return
  done < <(find "$HOME"/.ssh -name '*.config')
}
list() {
  lsof -a -c ssh -i :"$port" "$@"
}

cmd=(ssh -f -N -q "$1")
port=${2-$(dynamic-port "$1")}
if pgrep -fx "${cmd[*]}" >/dev/null; then
  list | grep -F -q '(CLOSE_WAIT)' || exit 0
  kill $(list -t)
fi
if list >&2; then
  echo "ERROR: port:$port is used by other process" >&2
  exit 1
else
  exec "${cmd[@]}" &
fi
