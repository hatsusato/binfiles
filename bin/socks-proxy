#!/bin/bash

set -eu

dynamic-port() {
  local IFS= line flag= b='[[:blank:]]'
  local config="$HOME"/.ssh/config
  local pattern="s/^$b\+DynamicForward$b\+\([0-9]*\)$b*$/\1/p"
  while read line; do
    if [[ $line == Host+( )* ]]; then
      flag=
      [[ $line == *+( )$1?( *) ]] && flag=on
    fi
    [[ -n $flag ]] && echo "$line"
  done <"$config" | sed -n "$pattern"
}
list() {
  lsof -a -c ssh -i :"$port" "$@"
}

cmd=(ssh -f -N -q "$1")
if [[ -n ${2+x} ]]; then
  port=$2
else
  port=$(dynamic-port "$1")
fi
if pgrep -fx "${cmd[*]}" >/dev/null; then
  list | grep -F -q '(CLOSE_WAIT)' || exit 0
  kill $(list -t)
fi
if list >&2; then
  echo "ERROR: port:$port is used by other process" >&2
  exit 1
else
  exec "${cmd[@]}" &
fi
