#!/bin/bash
# apt: emacs

set -eu
source ${BASH_SOURCE%/*}/function/error

usage() {
  cat <<EOF >&2
USAGE: $0 [-h] [-v]
    check whether spacemacs daemon is running

    -h  print this help
    -v  verbose mode
EOF
  exit 1
}
print() {
  local -i count=0
  pgrep -afx 'spacemacs --daemon' || count+=1
  pgrep -afx 'spacemacs --fg-daemon' || count+=1
  ((count < 2))
}
check() {
  case $? in
    124) error spacemacs hung up;;
    *) exit;;
  esac
}
main() {
  local var verbose= out
  while getopts hv var; do
    case $var in
      h) usage;;
      v) verbose=on;;
    esac
  done
  timeout 1s emacsclient -a false -e t &>/dev/null || check
  [[ -n $verbose ]] && print
  return 0
}

main "$@"
