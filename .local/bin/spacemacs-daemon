#!/bin/bash
# apt: emacs

set -eu

error() {
  cat <<EOF >&2
ERROR: $@
EOF
  exit 1
}
is-running() {
  local -i err=0
  spacemacs-exists || err=$?
  case $err in
    0) exit;;
    124) error spacemacs hung up;;
  esac
}
prepare() {
  local dir=$(init-run-user bin/spacemacs)
  [[ -d $dir ]] || exit
  lock=$dir/lock
  log=$dir/daemon.log
  mkdir -m700 "$lock" 2>/dev/null
}
main() {
  is-running
  local lock log
  prepare || error failed to retrieve lock: "$lock"
  trap "rm -fr ${lock@Q}" EXIT
  (exec -a spacemacs emacs --daemon 2>"$log")
}

main
