#!/bin/bash
# apt: gpg

set -eu

yubikey-status() {
  gpg --card-status --with-colons
}
yubikey-list() {
  gpg --list-secret-keys --with-colons
}
yubikey-card-edit() {
  gpg --batch --command-fd 0 --card-edit
}
yubikey-fetch() {
  cat <<EOF | yubikey-card-edit 2> >(grep ^gpg: >&2)
fetch
quit
EOF
}
prompt-insert() {
  read -n1 -p 'Insert YubiKey and Hit Any Key.' -s
  echo >&2
}
read-aid() {
  yubikey-status | awk -F: 'match($1, /^Reader$/) {print $4}'
}
read-keyid() {
  local aid=$1 keyid line ifs=$IFS
  local -a words
  while read line; do
    IFS=:
    words=($line)
    IFS=$ifs
    case ${words[0]} in
      sec) keyid=${words[4]};;
      ssb)
        if [[ ${words[14]} == $aid && -n $keyid ]]; then
          echo "$keyid"
          return
        fi;;
    esac
  done < <(yubikey-list)
}
main() {
  local aid keyid=
  until [[ -n $keyid ]]; do
    aid=$(read-aid)
    if [[ -n $aid ]]; then
      keyid=$(read-keyid "$aid")
      [[ -n $keyid ]] || yubikey-fetch
    else
      prompt-insert
    fi
  done
  echo "$keyid"
}

main
